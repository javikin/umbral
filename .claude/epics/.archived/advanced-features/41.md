---
name: widget-status
status: closed
priority: high
github: https://github.com/javikin/umbral/issues/41
created: 2026-01-06T02:54:04Z
updated: 2026-01-06T04:03:42Z
depends_on: [40]
parallel: true
---

# Task 2: Widget de Estado

## Objetivo

Crear widget que muestre el estado actual de bloqueo (activo/inactivo) y perfil.

## Implementación

### 1. Crear status_widget_info.xml

```xml
<!-- res/xml/status_widget_info.xml -->
<?xml version="1.0" encoding="utf-8"?>
<appwidget-provider xmlns:android="http://schemas.android.com/apk/res/android"
    android:minWidth="110dp"
    android:minHeight="40dp"
    android:targetCellWidth="2"
    android:targetCellHeight="1"
    android:resizeMode="horizontal|vertical"
    android:widgetCategory="home_screen"
    android:initialLayout="@layout/widget_status_loading"
    android:previewImage="@drawable/widget_status_preview"
    android:description="@string/widget_status_description"
    android:updatePeriodMillis="1800000" />
```

### 2. Crear StatusWidget.kt

```kotlin
package com.umbral.glance

import androidx.compose.runtime.Composable
import androidx.compose.ui.unit.dp
import androidx.glance.*
import androidx.glance.action.actionStartActivity
import androidx.glance.appwidget.*
import androidx.glance.layout.*
import androidx.glance.text.Text

class StatusWidget : GlanceAppWidget() {

    override val sizeMode = SizeMode.Responsive(
        setOf(
            DpSize(110.dp, 40.dp),  // 2x1
            DpSize(110.dp, 110.dp)  // 2x2
        )
    )

    @Composable
    override fun Content() {
        val size = LocalSize.current
        val isBlocked = // Obtener de BlockingRepository
        val profileName = // Obtener perfil activo

        GlanceTheme {
            if (size.width >= 110.dp && size.height >= 110.dp) {
                StatusWidgetLarge(isBlocked, profileName)
            } else {
                StatusWidgetSmall(isBlocked, profileName)
            }
        }
    }
}

@Composable
private fun StatusWidgetSmall(isBlocked: Boolean, profileName: String?) {
    Row(
        modifier = GlanceModifier
            .fillMaxSize()
            .background(WidgetColors.surface)
            .cornerRadius(16.dp)
            .clickable(actionStartActivity<MainActivity>())
            .padding(12.dp),
        verticalAlignment = Alignment.CenterVertically
    ) {
        Image(
            provider = ImageProvider(
                if (isBlocked) R.drawable.ic_lock else R.drawable.ic_lock_open
            ),
            contentDescription = null
        )
        Spacer(modifier = GlanceModifier.width(8.dp))
        Column {
            Text(
                text = if (isBlocked) "Bloqueado" else "Sin bloqueo",
                style = TextStyle(color = WidgetColors.onSurface)
            )
            if (profileName != null) {
                Text(
                    text = profileName,
                    style = TextStyle(color = WidgetColors.onSurfaceVariant)
                )
            }
        }
    }
}

@Composable
private fun StatusWidgetLarge(isBlocked: Boolean, profileName: String?) {
    Column(
        modifier = GlanceModifier
            .fillMaxSize()
            .background(WidgetColors.surface)
            .cornerRadius(16.dp)
            .clickable(actionStartActivity<MainActivity>())
            .padding(16.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Image(
            provider = ImageProvider(
                if (isBlocked) R.drawable.ic_lock else R.drawable.ic_lock_open
            ),
            contentDescription = null,
            modifier = GlanceModifier.size(48.dp)
        )
        Spacer(modifier = GlanceModifier.height(8.dp))
        Text(
            text = if (isBlocked) "Bloqueado" else "Sin bloqueo",
            style = TextStyle(color = WidgetColors.onSurface, fontSize = 16.sp)
        )
        if (profileName != null) {
            Text(
                text = profileName,
                style = TextStyle(color = WidgetColors.onSurfaceVariant)
            )
        }
    }
}
```

### 3. Crear StatusWidgetReceiver.kt

```kotlin
package com.umbral.glance

import androidx.glance.appwidget.GlanceAppWidget
import androidx.glance.appwidget.GlanceAppWidgetReceiver

class StatusWidgetReceiver : GlanceAppWidgetReceiver() {
    override val glanceAppWidget: GlanceAppWidget = StatusWidget()
}
```

### 4. Registrar en AndroidManifest.xml

```xml
<receiver
    android:name=".glance.StatusWidgetReceiver"
    android:exported="true">
    <intent-filter>
        <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
    </intent-filter>
    <meta-data
        android:name="android.appwidget.provider"
        android:resource="@xml/status_widget_info" />
</receiver>
```

### 5. Agregar Strings

```xml
<string name="widget_status_description">Muestra el estado de bloqueo de Umbral</string>
<string name="widget_status_blocked">Bloqueado</string>
<string name="widget_status_unblocked">Sin bloqueo</string>
```

## Criterio de Done

- [ ] Widget aparece en picker de Android
- [ ] Muestra estado correcto (bloqueado/desbloqueado)
- [ ] Muestra nombre del perfil activo
- [ ] Tap abre la app
- [ ] Soporta tamaños 2x1 y 2x2
- [ ] Se actualiza cuando cambia el estado

## Estimación

~6 horas
