---
name: quick-settings-tile
status: closed
priority: high
github: https://github.com/javikin/umbral/issues/43
created: 2026-01-06T02:54:04Z
updated: 2026-01-06T04:03:42Z
depends_on: []
parallel: true
---

# Task 4: Quick Settings Tile

## Objetivo

Crear tile en Quick Settings para toggle rápido del bloqueo.

## Implementación

### 1. Crear UmbralTileService.kt

```kotlin
package com.umbral.service

import android.content.Intent
import android.graphics.drawable.Icon
import android.service.quicksettings.Tile
import android.service.quicksettings.TileService
import android.widget.Toast
import com.umbral.R
import com.umbral.domain.repository.BlockingRepository
import com.umbral.domain.repository.ProfileRepository
import com.umbral.presentation.MainActivity
import dagger.hilt.android.AndroidEntryPoint
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.SupervisorJob
import kotlinx.coroutines.flow.first
import kotlinx.coroutines.launch
import javax.inject.Inject

@AndroidEntryPoint
class UmbralTileService : TileService() {

    @Inject
    lateinit var blockingRepository: BlockingRepository

    @Inject
    lateinit var profileRepository: ProfileRepository

    private val serviceScope = CoroutineScope(SupervisorJob() + Dispatchers.Main)

    override fun onStartListening() {
        super.onStartListening()
        updateTileState()
    }

    override fun onClick() {
        super.onClick()
        serviceScope.launch {
            val activeProfile = profileRepository.getActiveProfile().first()

            if (activeProfile == null) {
                // No hay perfil activo, abrir app
                openApp()
                return@launch
            }

            val isBlocking = blockingRepository.isBlocking().first()

            if (isBlocking) {
                // Intentar desbloquear
                if (activeProfile.isStrictMode) {
                    // Modo estricto - no se puede desde tile
                    Toast.makeText(
                        applicationContext,
                        "Requiere NFC o QR para desbloquear",
                        Toast.LENGTH_SHORT
                    ).show()
                } else {
                    // Modo normal - desbloquear
                    blockingRepository.stopBlocking()
                    updateTileState()
                }
            } else {
                // Activar bloqueo con perfil activo
                blockingRepository.startBlocking(activeProfile.id)
                updateTileState()
            }
        }
    }

    override fun onLongClick() {
        // Long press abre la app
        openApp()
    }

    private fun updateTileState() {
        serviceScope.launch {
            val isBlocking = blockingRepository.isBlocking().first()
            val activeProfile = profileRepository.getActiveProfile().first()

            qsTile?.apply {
                state = if (isBlocking) Tile.STATE_ACTIVE else Tile.STATE_INACTIVE

                label = if (isBlocking && activeProfile != null) {
                    activeProfile.name
                } else {
                    getString(R.string.tile_label_off)
                }

                subtitle = if (isBlocking) {
                    getString(R.string.tile_subtitle_active)
                } else {
                    getString(R.string.tile_subtitle_inactive)
                }

                icon = Icon.createWithResource(
                    applicationContext,
                    if (isBlocking) R.drawable.ic_shield_on else R.drawable.ic_shield_off
                )

                updateTile()
            }
        }
    }

    private fun openApp() {
        val intent = Intent(applicationContext, MainActivity::class.java).apply {
            addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
        }
        startActivityAndCollapse(intent)
    }
}
```

### 2. Registrar en AndroidManifest.xml

```xml
<service
    android:name=".service.UmbralTileService"
    android:icon="@drawable/ic_shield"
    android:label="@string/tile_label"
    android:permission="android.permission.BIND_QUICK_SETTINGS_TILE"
    android:exported="true">
    <intent-filter>
        <action android:name="android.service.quicksettings.action.QS_TILE" />
    </intent-filter>
    <meta-data
        android:name="android.service.quicksettings.ACTIVE_TILE"
        android:value="true" />
</service>
```

### 3. Agregar Strings

```xml
<string name="tile_label">Umbral</string>
<string name="tile_label_off">Umbral: Off</string>
<string name="tile_subtitle_active">Bloqueo activo</string>
<string name="tile_subtitle_inactive">Toca para activar</string>
<string name="tile_strict_mode_message">Requiere NFC o QR para desbloquear</string>
```

### 4. Crear Iconos

- `ic_shield_on.xml` - Escudo activo (púrpura)
- `ic_shield_off.xml` - Escudo inactivo (gris)

## Criterio de Done

- [ ] Tile aparece en Quick Settings (después de agregarlo)
- [ ] Muestra estado correcto (activo/inactivo)
- [ ] Tap en modo normal: toggle bloqueo
- [ ] Tap en modo estricto: muestra toast
- [ ] Long press: abre la app
- [ ] Se actualiza cuando cambia el estado

## Testing

1. Agregar tile desde Quick Settings editor
2. Verificar estados visuales
3. Probar toggle en modo normal
4. Probar bloqueo en modo estricto
5. Verificar que tile se actualiza al cambiar desde la app

## Estimación

~4 horas
