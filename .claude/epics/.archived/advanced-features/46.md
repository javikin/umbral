---
name: stats-charts
status: closed
priority: medium
github: https://github.com/javikin/umbral/issues/46
created: 2026-01-06T02:54:04Z
updated: 2026-01-06T04:03:42Z
depends_on: [44, 45]
parallel: false
---

# Task 7: Stats Charts & Top Apps

## Objetivo

Crear componentes de gráfica semanal y lista de top apps bloqueadas.

## Implementación

### 1. Crear WeeklyChart.kt

```kotlin
// presentation/ui/screens/stats/components/WeeklyChart.kt
package com.umbral.presentation.ui.screens.stats.components

import androidx.compose.foundation.Canvas
import androidx.compose.foundation.layout.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Text
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.CornerRadius
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.geometry.Size
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import com.umbral.data.local.dao.DailyStats
import java.time.LocalDate
import java.time.format.TextStyle
import java.util.*

@Composable
fun WeeklyChartCard(
    dailyStats: List<DailyStats>,
    modifier: Modifier = Modifier
) {
    UmbralCard(modifier = modifier) {
        Column(
            modifier = Modifier.padding(UmbralSpacing.md)
        ) {
            Text(
                text = "Últimos 7 días",
                style = MaterialTheme.typography.titleMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )

            Spacer(modifier = Modifier.height(UmbralSpacing.md))

            WeeklyBarChart(
                dailyStats = dailyStats,
                modifier = Modifier
                    .fillMaxWidth()
                    .height(120.dp)
            )
        }
    }
}

@Composable
private fun WeeklyBarChart(
    dailyStats: List<DailyStats>,
    modifier: Modifier = Modifier
) {
    val primaryColor = MaterialTheme.colorScheme.primary
    val surfaceVariantColor = MaterialTheme.colorScheme.surfaceVariant
    val onSurfaceVariant = MaterialTheme.colorScheme.onSurfaceVariant

    // Preparar datos para los últimos 7 días
    val last7Days = (6 downTo 0).map { daysAgo ->
        LocalDate.now().minusDays(daysAgo.toLong())
    }

    val dataMap = dailyStats.associate { it.day to it.minutes }
    val maxMinutes = dailyStats.maxOfOrNull { it.minutes } ?: 1

    Column(modifier = modifier) {
        // Barras
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .weight(1f),
            horizontalArrangement = Arrangement.SpaceEvenly,
            verticalAlignment = Alignment.Bottom
        ) {
            last7Days.forEach { date ->
                val dateKey = date.toString()
                val minutes = dataMap[dateKey] ?: 0
                val heightFraction = if (maxMinutes > 0) minutes.toFloat() / maxMinutes else 0f
                val isToday = date == LocalDate.now()

                Column(
                    horizontalAlignment = Alignment.CenterHorizontally,
                    modifier = Modifier.weight(1f)
                ) {
                    Box(
                        modifier = Modifier
                            .fillMaxHeight(heightFraction.coerceAtLeast(0.05f))
                            .width(24.dp)
                    ) {
                        Canvas(modifier = Modifier.fillMaxSize()) {
                            drawRoundRect(
                                color = if (isToday) primaryColor else surfaceVariantColor,
                                topLeft = Offset.Zero,
                                size = Size(size.width, size.height),
                                cornerRadius = CornerRadius(4.dp.toPx())
                            )
                        }
                    }
                }
            }
        }

        Spacer(modifier = Modifier.height(8.dp))

        // Labels de días
        Row(
            modifier = Modifier.fillMaxWidth(),
            horizontalArrangement = Arrangement.SpaceEvenly
        ) {
            last7Days.forEach { date ->
                val dayLabel = date.dayOfWeek
                    .getDisplayName(TextStyle.NARROW, Locale("es"))
                    .uppercase()
                val isToday = date == LocalDate.now()

                Text(
                    text = dayLabel,
                    style = MaterialTheme.typography.labelSmall,
                    color = if (isToday) primaryColor else onSurfaceVariant,
                    textAlign = TextAlign.Center,
                    modifier = Modifier.weight(1f)
                )
            }
        }
    }
}
```

### 2. Crear TopAppsCard.kt

```kotlin
// presentation/ui/screens/stats/components/TopAppsCard.kt
package com.umbral.presentation.ui.screens.stats.components

import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.unit.dp
import com.umbral.data.local.dao.AppAttemptCount
import com.umbral.presentation.ui.components.AppIcon

@Composable
fun TopAppsCard(
    apps: List<AppAttemptCount>,
    modifier: Modifier = Modifier
) {
    if (apps.isEmpty()) return

    UmbralCard(modifier = modifier) {
        Column(
            modifier = Modifier.padding(UmbralSpacing.md)
        ) {
            Text(
                text = "Top apps bloqueadas",
                style = MaterialTheme.typography.titleMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )

            Spacer(modifier = Modifier.height(UmbralSpacing.md))

            apps.forEachIndexed { index, app ->
                TopAppItem(
                    rank = index + 1,
                    packageName = app.packageName,
                    attemptCount = app.count
                )

                if (index < apps.lastIndex) {
                    Spacer(modifier = Modifier.height(UmbralSpacing.sm))
                }
            }
        }
    }
}

@Composable
private fun TopAppItem(
    rank: Int,
    packageName: String,
    attemptCount: Int
) {
    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = Arrangement.SpaceBetween,
        verticalAlignment = Alignment.CenterVertically
    ) {
        Row(
            verticalAlignment = Alignment.CenterVertically
        ) {
            // Rank badge
            Surface(
                color = MaterialTheme.colorScheme.primary.copy(alpha = 0.1f),
                shape = MaterialTheme.shapes.small,
                modifier = Modifier.size(28.dp)
            ) {
                Box(contentAlignment = Alignment.Center) {
                    Text(
                        text = rank.toString(),
                        style = MaterialTheme.typography.labelMedium,
                        color = MaterialTheme.colorScheme.primary
                    )
                }
            }

            Spacer(modifier = Modifier.width(UmbralSpacing.sm))

            // App icon
            AppIcon(
                packageName = packageName,
                modifier = Modifier.size(32.dp)
            )

            Spacer(modifier = Modifier.width(UmbralSpacing.sm))

            // App name (extraer del package name)
            Text(
                text = getAppDisplayName(packageName),
                style = MaterialTheme.typography.bodyMedium,
                color = MaterialTheme.colorScheme.onSurface
            )
        }

        // Attempt count
        Text(
            text = "$attemptCount intentos",
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}

private fun getAppDisplayName(packageName: String): String {
    // Extraer nombre legible del package name
    return when {
        packageName.contains("instagram") -> "Instagram"
        packageName.contains("facebook") -> "Facebook"
        packageName.contains("tiktok") || packageName.contains("musical") -> "TikTok"
        packageName.contains("twitter") || packageName.contains("x.") -> "X (Twitter)"
        packageName.contains("whatsapp") -> "WhatsApp"
        packageName.contains("youtube") -> "YouTube"
        packageName.contains("snapchat") -> "Snapchat"
        packageName.contains("messenger") -> "Messenger"
        packageName.contains("pinterest") -> "Pinterest"
        packageName.contains("reddit") -> "Reddit"
        else -> packageName.substringAfterLast(".")
            .replaceFirstChar { it.uppercase() }
    }
}
```

### 3. Crear AppIcon.kt (si no existe)

```kotlin
// presentation/ui/components/AppIcon.kt
package com.umbral.presentation.ui.components

import android.content.pm.PackageManager
import android.graphics.drawable.Drawable
import androidx.compose.foundation.Image
import androidx.compose.runtime.*
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.asImageBitmap
import androidx.compose.ui.platform.LocalContext
import androidx.core.graphics.drawable.toBitmap

@Composable
fun AppIcon(
    packageName: String,
    modifier: Modifier = Modifier
) {
    val context = LocalContext.current
    var drawable by remember { mutableStateOf<Drawable?>(null) }

    LaunchedEffect(packageName) {
        drawable = try {
            context.packageManager.getApplicationIcon(packageName)
        } catch (e: PackageManager.NameNotFoundException) {
            null
        }
    }

    drawable?.let {
        Image(
            bitmap = it.toBitmap().asImageBitmap(),
            contentDescription = null,
            modifier = modifier
        )
    }
}
```

### 4. Actualizar StatsScreen para usar componentes

Los componentes `WeeklyChartCard` y `TopAppsCard` ya están referenciados en `StatsScreen.kt` de Task 6.

## Criterio de Done

- [ ] Gráfica de barras muestra datos de 7 días
- [ ] Día actual destacado con color primario
- [ ] Labels de días en español
- [ ] Top 5 apps con iconos reales
- [ ] Número de intentos por app
- [ ] UI consistente con tema Umbral

## Estimación

~4 horas
