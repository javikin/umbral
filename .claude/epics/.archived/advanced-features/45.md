---
name: stats-screen
status: closed
priority: medium
github: https://github.com/javikin/umbral/issues/45
created: 2026-01-06T02:54:04Z
updated: 2026-01-06T04:03:42Z
depends_on: [44]
parallel: false
---

# Task 6: Stats Screen UI

## Objetivo

Crear la pantalla de estadísticas con tiempo bloqueado, comparativas y métricas.

## Implementación

### 1. Crear StatsViewModel

```kotlin
// presentation/ui/screens/stats/StatsViewModel.kt
package com.umbral.presentation.ui.screens.stats

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.umbral.domain.repository.StatsRepository
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import javax.inject.Inject

@HiltViewModel
class StatsViewModel @Inject constructor(
    private val statsRepository: StatsRepository
) : ViewModel() {

    private val _uiState = MutableStateFlow(StatsUiState())
    val uiState: StateFlow<StatsUiState> = _uiState.asStateFlow()

    init {
        loadStats()
    }

    fun loadStats() {
        viewModelScope.launch {
            _uiState.value = _uiState.value.copy(isLoading = true)

            try {
                val todayStats = statsRepository.getTodayStats()
                val weeklyStats = statsRepository.getWeeklyStats()

                _uiState.value = StatsUiState(
                    isLoading = false,
                    todayBlockedMinutes = todayStats.blockedMinutes,
                    todayAttempts = todayStats.attemptCount,
                    weeklyBlockedMinutes = weeklyStats.totalMinutes,
                    previousWeekMinutes = weeklyStats.previousWeekMinutes,
                    dailyStats = weeklyStats.dailyStats,
                    topApps = weeklyStats.topApps
                )
            } catch (e: Exception) {
                _uiState.value = _uiState.value.copy(
                    isLoading = false,
                    error = e.message
                )
            }
        }
    }

    fun calculatePercentageChange(): Int {
        val current = _uiState.value.weeklyBlockedMinutes
        val previous = _uiState.value.previousWeekMinutes
        if (previous == 0) return if (current > 0) 100 else 0
        return ((current - previous) * 100 / previous)
    }
}

data class StatsUiState(
    val isLoading: Boolean = true,
    val error: String? = null,
    val todayBlockedMinutes: Int = 0,
    val todayAttempts: Int = 0,
    val weeklyBlockedMinutes: Int = 0,
    val previousWeekMinutes: Int = 0,
    val dailyStats: List<DailyStats> = emptyList(),
    val topApps: List<AppAttemptCount> = emptyList()
)
```

### 2. Crear StatsScreen

```kotlin
// presentation/ui/screens/stats/StatsScreen.kt
package com.umbral.presentation.ui.screens.stats

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import com.umbral.presentation.ui.components.*
import com.umbral.presentation.ui.theme.UmbralSpacing

@Composable
fun StatsScreen(
    viewModel: StatsViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsState()
    val percentageChange = viewModel.calculatePercentageChange()

    LazyColumn(
        modifier = Modifier
            .fillMaxSize()
            .padding(horizontal = UmbralSpacing.md),
        verticalArrangement = Arrangement.spacedBy(UmbralSpacing.md)
    ) {
        item {
            Spacer(modifier = Modifier.height(UmbralSpacing.md))
        }

        // Tiempo bloqueado hoy
        item {
            TodayStatsCard(
                blockedMinutes = uiState.todayBlockedMinutes,
                attempts = uiState.todayAttempts
            )
        }

        // Estadísticas semanales
        item {
            WeeklyStatsCard(
                totalMinutes = uiState.weeklyBlockedMinutes,
                percentageChange = percentageChange
            )
        }

        // Gráfica semanal (Task 7)
        item {
            WeeklyChartCard(
                dailyStats = uiState.dailyStats
            )
        }

        // Intentos bloqueados
        item {
            AttemptsCard(
                totalAttempts = uiState.todayAttempts
            )
        }

        // Top apps (Task 7)
        item {
            TopAppsCard(
                apps = uiState.topApps
            )
        }

        item {
            Spacer(modifier = Modifier.height(UmbralSpacing.xl))
        }
    }
}

@Composable
private fun TodayStatsCard(
    blockedMinutes: Int,
    attempts: Int
) {
    UmbralCard {
        Column(
            modifier = Modifier.padding(UmbralSpacing.md)
        ) {
            Text(
                text = "Hoy",
                style = MaterialTheme.typography.titleMedium,
                color = MaterialTheme.colorScheme.onSurfaceVariant
            )

            Spacer(modifier = Modifier.height(UmbralSpacing.sm))

            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween
            ) {
                StatItem(
                    value = formatDuration(blockedMinutes),
                    label = "Tiempo bloqueado"
                )
                StatItem(
                    value = attempts.toString(),
                    label = "Intentos"
                )
            }
        }
    }
}

@Composable
private fun WeeklyStatsCard(
    totalMinutes: Int,
    percentageChange: Int
) {
    UmbralCard {
        Column(
            modifier = Modifier.padding(UmbralSpacing.md)
        ) {
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column {
                    Text(
                        text = "Esta semana",
                        style = MaterialTheme.typography.titleMedium,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                    Text(
                        text = formatDuration(totalMinutes),
                        style = MaterialTheme.typography.headlineMedium,
                        color = MaterialTheme.colorScheme.onSurface
                    )
                }

                PercentageChangeChip(percentageChange)
            }
        }
    }
}

@Composable
private fun PercentageChangeChip(percentageChange: Int) {
    val isPositive = percentageChange >= 0
    val color = if (isPositive) {
        MaterialTheme.colorScheme.primary
    } else {
        MaterialTheme.colorScheme.error
    }

    Surface(
        color = color.copy(alpha = 0.1f),
        shape = MaterialTheme.shapes.small
    ) {
        Text(
            text = "${if (isPositive) "+" else ""}$percentageChange%",
            modifier = Modifier.padding(horizontal = 8.dp, vertical = 4.dp),
            color = color,
            style = MaterialTheme.typography.labelMedium
        )
    }
}

@Composable
private fun AttemptsCard(totalAttempts: Int) {
    UmbralCard {
        Row(
            modifier = Modifier
                .fillMaxWidth()
                .padding(UmbralSpacing.md),
            horizontalArrangement = Arrangement.SpaceBetween,
            verticalAlignment = Alignment.CenterVertically
        ) {
            Text(
                text = "Intentos bloqueados",
                style = MaterialTheme.typography.titleMedium,
                color = MaterialTheme.colorScheme.onSurface
            )
            Text(
                text = totalAttempts.toString(),
                style = MaterialTheme.typography.headlineSmall,
                color = MaterialTheme.colorScheme.primary
            )
        }
    }
}

@Composable
private fun StatItem(value: String, label: String) {
    Column {
        Text(
            text = value,
            style = MaterialTheme.typography.headlineSmall,
            color = MaterialTheme.colorScheme.onSurface
        )
        Text(
            text = label,
            style = MaterialTheme.typography.bodySmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}

private fun formatDuration(minutes: Int): String {
    val hours = minutes / 60
    val mins = minutes % 60
    return when {
        hours > 0 && mins > 0 -> "${hours}h ${mins}m"
        hours > 0 -> "${hours}h"
        else -> "${mins}m"
    }
}
```

### 3. Agregar a Navegación

```kotlin
// En MainNavigation.kt o NavGraph.kt
composable("stats") {
    StatsScreen()
}
```

### 4. Agregar Strings

```xml
<string name="stats_title">Estadísticas</string>
<string name="stats_today">Hoy</string>
<string name="stats_this_week">Esta semana</string>
<string name="stats_blocked_time">Tiempo bloqueado</string>
<string name="stats_attempts">Intentos</string>
<string name="stats_attempts_blocked">Intentos bloqueados</string>
<string name="stats_top_apps">Top apps bloqueadas</string>
```

## Criterio de Done

- [ ] StatsViewModel con estados correctos
- [ ] UI muestra tiempo bloqueado hoy
- [ ] UI muestra tiempo bloqueado semanal
- [ ] UI muestra comparativa con semana anterior
- [ ] UI muestra contador de intentos
- [ ] Textos en español
- [ ] Loading y error states

## Estimación

~4 horas
