---
name: Fix Thread Context - cancelNotification en main thread
status: closed
created: 2026-01-16T04:06:48Z
updated: 2026-01-16T15:09:23Z
github: https://github.com/javikin/umbral/issues/76
depends_on: [73]
parallel: false
conflicts_with: []
---

# Task: Fix Thread Context - cancelNotification en main thread inmediatamente

## Description

Aplicar el fix cr√≠tico identificado en la investigaci√≥n (#73): cambiar `cancelNotification()` para que se ejecute **inmediatamente en main thread**, y mover el guardado a BD a un proceso async **despu√©s** de la cancelaci√≥n.

## Root Cause (Identificada en #73)

1. **Thread Context Violation**: `cancelNotification()` se llama desde `Dispatchers.IO`, pero AOSP documenta que todas las callbacks de `NotificationListenerService` corren en main thread desde Android N
2. **Race Condition**: Se guarda en BD (10-100ms) ANTES de cancelar, dando tiempo a Android de "asentar" la notificaci√≥n

## Acceptance Criteria

- [ ] `cancelNotification()` se ejecuta inmediatamente en main thread
- [ ] Guardado en Room ocurre DESPU√âS de cancelar (async)
- [ ] Agregar flag `isServiceConnected` como guard
- [ ] Notificaciones de apps bloqueadas NO aparecen en barra de estado
- [ ] Apps NO bloqueadas siguen recibiendo notificaciones normalmente

## Technical Details

### C√≥digo actual (INCORRECTO)
```kotlin
override fun onNotificationPosted(sbn: StatusBarNotification?) {
    // ...
    serviceScope.launch {  // ‚ùå Dispatchers.IO
        val isWhitelisted = whitelistChecker.shouldAllowNotification(sbn)
        // ...
        storeAndCancelNotification(sbn, sessionId)  // ‚ùå BD antes de cancelar
    }
}

private suspend fun storeAndCancelNotification(...) {
    saveNotificationUseCase(blockedNotification)  // ‚ùå Bloquea 10-100ms
    cancelNotification(sbn.key)  // ‚ùå Muy tarde, thread incorrecto
}
```

### C√≥digo corregido (IMPLEMENTAR)
```kotlin
@Volatile
private var isServiceConnected = false

override fun onListenerConnected() {
    super.onListenerConnected()
    isServiceConnected = true
    Timber.i("NotificationListener connected")
}

override fun onListenerDisconnected() {
    super.onListenerDisconnected()
    isServiceConnected = false
    // ... requestRebind
}

override fun onNotificationPosted(sbn: StatusBarNotification?) {
    sbn ?: return

    // Guard: verificar conexi√≥n
    if (!isServiceConnected) {
        Timber.w("Service not connected, ignoring")
        return
    }

    val sessionId = currentSessionId ?: return
    val packageName = sbn.packageName

    if (packageName !in blockedApps) return

    // Whitelist check S√çNCRONO (refactorizar si es necesario)
    if (shouldAllowNotificationSync(sbn)) {
        Timber.d("‚úÖ Allowed (whitelisted): $packageName")
        return
    }

    // ‚úÖ CANCELAR INMEDIATAMENTE en main thread
    Timber.d("üö´ Blocking: $packageName")
    cancelNotification(sbn.key)
    Timber.d("‚úÖ Cancelled: ${sbn.key}")

    // ‚úÖ Guardar DESPU√âS de cancelar (async)
    serviceScope.launch {
        saveBlockedNotification(sbn, sessionId)
    }
}

private suspend fun saveBlockedNotification(sbn: StatusBarNotification, sessionId: String) {
    // Solo guardar, NO cancelar aqu√≠
    val blockedNotification = BlockedNotification(...)
    saveNotificationUseCase(blockedNotification)
    Timber.d("Notification saved to history")
}
```

### Archivo a modificar
- `app/src/main/java/com/umbral/notifications/service/UmbralNotificationService.kt`

### Cambios en whitelist checker (si es suspend)
Si `whitelistChecker.shouldAllowNotification()` es suspend, considerar:
1. Hacerla s√≠ncrona (preferido para velocidad)
2. O usar `runBlocking` solo para el check (no ideal pero funcional)

## Dependencies

- [x] #73: Investigaci√≥n completada ‚úÖ
- [x] #74: Logging ya implementado ‚úÖ
- [x] #75: DI no es el problema ‚úÖ

## Effort Estimate

- Size: S-M
- Hours: 1-2
- Parallel: false

## Definition of Done

- [ ] Fix implementado seg√∫n especificaci√≥n
- [ ] App compila exitosamente
- [ ] Test manual: notificaci√≥n de app bloqueada NO aparece
- [ ] Test manual: notificaci√≥n de app NO bloqueada S√ç aparece
- [ ] Logs confirman: "Cancelled" aparece inmediatamente despu√©s de "Blocking"

## References

- Investigaci√≥n completa: `docs/temp/notification-cancelation-research.md`
- AOSP source: callbacks en main thread desde Android N
- Gadgetbridge: ejemplo de implementaci√≥n correcta
