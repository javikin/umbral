---
name: fix-navigation-backstack
status: closed
priority: critical
github: https://github.com/javikin/umbral/issues/24
created: 2026-01-04T23:34:58Z
updated: 2026-01-04T23:34:58Z
depends_on: []
parallel: true
---

# Task 2: Fix Navegación Backstack

## Problema

Después de completar onboarding y permisos, el usuario puede navegar hacia atrás y volver al onboarding.

## Causa Raíz

La navegación no limpia el backstack al transicionar entre secciones principales.

## Solución

### 1. Actualizar NavGraph.kt

```kotlin
// Al navegar de Onboarding a Permisos
navController.navigate(Screen.Permissions.route) {
    popUpTo(Screen.Onboarding.route) { inclusive = true }
}

// Al navegar de Permisos a AppSelector
navController.navigate(Screen.AppSelector.route) {
    popUpTo(Screen.Permissions.route) { inclusive = true }
}

// Al navegar de AppSelector a Home
navController.navigate(Screen.Home.route) {
    popUpTo(0) { inclusive = true } // Limpia todo el backstack
}
```

### 2. Manejar Back Button

```kotlin
// En OnboardingScreen
BackHandler {
    // Salir de la app en lugar de navegar atrás
    activity?.finish()
}
```

### 3. Deshabilitar Swipe Back (si usa Accompanist)

```kotlin
Scaffold(
    // Deshabilitar gesture navigation durante onboarding
)
```

## Archivos a Modificar

- `app/src/main/java/com/umbral/presentation/navigation/NavGraph.kt`
- `app/src/main/java/com/umbral/presentation/navigation/Screen.kt`
- `app/src/main/java/com/umbral/presentation/ui/screens/onboarding/OnboardingScreen.kt`
- `app/src/main/java/com/umbral/presentation/ui/screens/permissions/PermissionsScreen.kt`

## Criterio de Done

- [ ] No se puede volver al onboarding después de completarlo
- [ ] Botón físico "atrás" sale de la app durante onboarding
- [ ] Flujo es lineal: Onboarding → Permisos → Selector → Home
- [ ] Sin crashes por navegación

## Testing

1. Completar onboarding
2. Otorgar permisos
3. Presionar botón atrás
4. Verificar que NO vuelve al onboarding
