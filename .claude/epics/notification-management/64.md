---
name: Whitelist de notificaciones críticas
status: open
created: 2026-01-07T20:19:34Z
updated: 2026-01-07T20:28:45Z
github: https://github.com/javikin/umbral/issues/64
depends_on: [63]
parallel: false
conflicts_with: []
---

# Task: Whitelist de notificaciones críticas

## Description

Implementar la lógica de whitelist que asegura que notificaciones críticas (llamadas, SMS, alarmas, batería baja) siempre pasen sin ser bloqueadas. Incluye una whitelist configurable para apps bancarias y autenticadores 2FA.

## Acceptance Criteria

- [ ] Llamadas entrantes siempre pasan (Dialer, Phone apps)
- [ ] SMS/mensajes siempre pasan (Messages, SMS apps)
- [ ] Alarmas del sistema siempre pasan
- [ ] Alertas de batería baja siempre pasan
- [ ] DataStore para whitelist configurable por usuario
- [ ] UI en Settings para agregar apps a whitelist personalizada
- [ ] Lógica integrada en UmbralNotificationService

## Technical Details

### Files to Create/Modify
```
app/src/main/java/com/umbral/notifications/
├── domain/
│   └── model/
│       └── NotificationWhitelist.kt
├── data/
│   └── preferences/
│       └── NotificationPreferences.kt
└── service/
    └── UmbralNotificationService.kt (modify)
```

### System Whitelist (Hardcoded)
```kotlin
object SystemWhitelist {
    // Package prefixes that are always allowed
    val ALWAYS_ALLOWED = setOf(
        "com.android.dialer",
        "com.google.android.dialer",
        "com.samsung.android.dialer",
        "com.android.phone",
        "com.android.mms",
        "com.google.android.apps.messaging",
        "com.samsung.android.messaging",
        "com.android.deskclock",
        "com.google.android.deskclock",
    )

    // Notification categories that are always allowed
    val ALLOWED_CATEGORIES = setOf(
        Notification.CATEGORY_CALL,
        Notification.CATEGORY_ALARM,
        Notification.CATEGORY_MESSAGE,  // SMS only, not chat apps
    )

    // Package patterns for common authenticators
    val COMMON_AUTHENTICATORS = setOf(
        "com.google.android.apps.authenticator",
        "com.authy.authy",
        "com.microsoft.msa.authenticator",
        "org.fedorahosted.freeotp",
    )
}
```

### Whitelist Check Logic
```kotlin
fun shouldAllowNotification(sbn: StatusBarNotification): Boolean {
    // 1. Check system whitelist
    if (sbn.packageName in SystemWhitelist.ALWAYS_ALLOWED) return true

    // 2. Check notification category
    val category = sbn.notification.category
    if (category in SystemWhitelist.ALLOWED_CATEGORIES) return true

    // 3. Check user whitelist (from DataStore)
    if (sbn.packageName in userWhitelist) return true

    // 4. Check for low battery notification
    if (isBatteryLowNotification(sbn)) return true

    return false
}
```

### User Preferences
```kotlin
@Singleton
class NotificationPreferences @Inject constructor(
    private val dataStore: DataStore<Preferences>
) {
    val userWhitelist: Flow<Set<String>> = dataStore.data
        .map { prefs ->
            prefs[USER_WHITELIST_KEY]?.split(",")?.toSet() ?: emptySet()
        }

    suspend fun addToWhitelist(packageName: String)
    suspend fun removeFromWhitelist(packageName: String)
}
```

## Dependencies

- [ ] Task 001 - UmbralNotificationService must exist
- [ ] DataStore (already in project)

## Effort Estimate

- Size: M
- Hours: 4
- Parallel: false (depends on 001)

## Definition of Done

- [ ] System whitelist blocks critical notifications from being hidden
- [ ] User can add apps to personal whitelist in Settings
- [ ] DataStore persists whitelist preferences
- [ ] Common authenticators suggested in UI
- [ ] Tests verify whitelist logic works correctly
