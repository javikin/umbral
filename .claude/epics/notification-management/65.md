---
name: Room entity, DAO y migration
status: open
created: 2026-01-07T20:19:34Z
updated: 2026-01-07T20:28:45Z
github: https://github.com/javikin/umbral/issues/65
depends_on: []
parallel: true
conflicts_with: [66]
---

# Task: Room entity, DAO y migration

## Description

Crear la entidad Room `BlockedNotificationEntity` para almacenar notificaciones bloqueadas, el DAO con operaciones CRUD, y la migración de base de datos para agregar la nueva tabla.

## Acceptance Criteria

- [ ] `BlockedNotificationEntity` con todos los campos necesarios
- [ ] `BlockedNotificationDao` con operaciones CRUD completas
- [ ] Query para obtener notificaciones por sesión
- [ ] Query para contar notificaciones por app
- [ ] Migración de DB (versión N → N+1)
- [ ] Índices para queries frecuentes
- [ ] Límite FIFO de 1000 registros implementado

## Technical Details

### Files to Create
```
app/src/main/java/com/umbral/notifications/data/local/
├── BlockedNotificationEntity.kt
└── BlockedNotificationDao.kt

supabase/migrations/
└── XXXXXXXX_add_blocked_notifications_table.sql (migration)
```

### Entity Definition
```kotlin
@Entity(
    tableName = "blocked_notifications",
    indices = [
        Index(value = ["session_id"]),
        Index(value = ["package_name"]),
        Index(value = ["timestamp"])
    ]
)
data class BlockedNotificationEntity(
    @PrimaryKey(autoGenerate = true)
    val id: Long = 0,

    @ColumnInfo(name = "session_id")
    val sessionId: String,

    @ColumnInfo(name = "package_name")
    val packageName: String,

    @ColumnInfo(name = "app_name")
    val appName: String,

    @ColumnInfo(name = "title")
    val title: String?,

    @ColumnInfo(name = "text")
    val text: String?,

    @ColumnInfo(name = "timestamp")
    val timestamp: Long,

    @ColumnInfo(name = "icon_uri")
    val iconUri: String?,

    @ColumnInfo(name = "is_read")
    val isRead: Boolean = false
)
```

### DAO Definition
```kotlin
@Dao
interface BlockedNotificationDao {

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insert(notification: BlockedNotificationEntity): Long

    @Query("SELECT * FROM blocked_notifications WHERE session_id = :sessionId ORDER BY timestamp DESC")
    fun getBySession(sessionId: String): Flow<List<BlockedNotificationEntity>>

    @Query("SELECT * FROM blocked_notifications ORDER BY timestamp DESC LIMIT :limit")
    fun getRecent(limit: Int = 100): Flow<List<BlockedNotificationEntity>>

    @Query("""
        SELECT package_name, app_name, COUNT(*) as count
        FROM blocked_notifications
        WHERE session_id = :sessionId
        GROUP BY package_name
        ORDER BY count DESC
    """)
    suspend fun getCountByAppForSession(sessionId: String): List<AppNotificationCount>

    @Query("SELECT COUNT(*) FROM blocked_notifications WHERE session_id = :sessionId")
    suspend fun getCountForSession(sessionId: String): Int

    @Query("SELECT COUNT(*) FROM blocked_notifications")
    suspend fun getTotalCount(): Int

    @Query("UPDATE blocked_notifications SET is_read = 1 WHERE id = :id")
    suspend fun markAsRead(id: Long)

    @Query("DELETE FROM blocked_notifications WHERE id = :id")
    suspend fun delete(id: Long)

    @Query("DELETE FROM blocked_notifications WHERE timestamp < :olderThan")
    suspend fun deleteOlderThan(olderThan: Long)

    @Query("""
        DELETE FROM blocked_notifications
        WHERE id NOT IN (
            SELECT id FROM blocked_notifications
            ORDER BY timestamp DESC
            LIMIT :keepCount
        )
    """)
    suspend fun trimToLimit(keepCount: Int = 1000)
}

data class AppNotificationCount(
    @ColumnInfo(name = "package_name") val packageName: String,
    @ColumnInfo(name = "app_name") val appName: String,
    @ColumnInfo(name = "count") val count: Int
)
```

### Database Migration
```kotlin
val MIGRATION_X_Y = object : Migration(X, Y) {
    override fun migrate(database: SupportSQLiteDatabase) {
        database.execSQL("""
            CREATE TABLE IF NOT EXISTS blocked_notifications (
                id INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,
                session_id TEXT NOT NULL,
                package_name TEXT NOT NULL,
                app_name TEXT NOT NULL,
                title TEXT,
                text TEXT,
                timestamp INTEGER NOT NULL,
                icon_uri TEXT,
                is_read INTEGER NOT NULL DEFAULT 0
            )
        """)
        database.execSQL("CREATE INDEX IF NOT EXISTS index_blocked_notifications_session_id ON blocked_notifications(session_id)")
        database.execSQL("CREATE INDEX IF NOT EXISTS index_blocked_notifications_package_name ON blocked_notifications(package_name)")
        database.execSQL("CREATE INDEX IF NOT EXISTS index_blocked_notifications_timestamp ON blocked_notifications(timestamp)")
    }
}
```

### Update UmbralDatabase
```kotlin
@Database(
    entities = [
        // ... existing entities
        BlockedNotificationEntity::class
    ],
    version = X + 1
)
abstract class UmbralDatabase : RoomDatabase() {
    // ... existing DAOs
    abstract fun blockedNotificationDao(): BlockedNotificationDao
}
```

## Dependencies

- [ ] No task dependencies
- [ ] Room Database (already in project)

## Effort Estimate

- Size: M
- Hours: 3
- Parallel: true

## Definition of Done

- [ ] Entity compiles without errors
- [ ] DAO methods work correctly
- [ ] Migration runs successfully
- [ ] Existing data preserved after migration
- [ ] Indices improve query performance
- [ ] FIFO cleanup logic tested
