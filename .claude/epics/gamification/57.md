---
name: ExpeditionMapScreen con Canvas
status: open
created: 2026-01-07T05:02:20Z
updated: 2026-01-07T05:13:26Z
github: https://github.com/javikin/umbral/issues/57
depends_on: [55]
parallel: false
conflicts_with: []
---

# Task: ExpeditionMapScreen con Canvas

## Description

Implementar la pantalla principal del mapa de exploración usando Jetpack Compose Canvas. El mapa debe mostrar el Bioma Bosque con fog of war, locaciones descubribles, y soporte para gestos de pan/zoom.

## Acceptance Criteria

- [ ] Mapa renderiza correctamente con Canvas
- [ ] Fog of war cubre áreas no descubiertas
- [ ] 15 locaciones posicionadas en el mapa
- [ ] Tap en locación muestra detalle/permite descubrir
- [ ] Pan gesture funciona suavemente
- [ ] Zoom gesture con pinch (opcional para MVP)
- [ ] Indicador de Energía disponible
- [ ] Animación al descubrir nueva locación

## Technical Details

### 1. Biome Data Definition

```kotlin
// BiomeData.kt
object ForestBiomeData {
    val BIOME_ID = "forest"
    val BIOME_NAME = "Bosque Inicial"

    // Map dimensions (in abstract units)
    const val MAP_WIDTH = 1000f
    const val MAP_HEIGHT = 1500f

    // Location definitions
    val LOCATIONS = listOf(
        LocationDef("forest_entrance", "Entrada del Bosque", 500f, 1400f,
            "El camino comienza aquí...", 0),
        LocationDef("old_oak", "Roble Antiguo", 300f, 1200f,
            "Un árbol centenario guarda secretos.", 200),
        LocationDef("mushroom_grove", "Claro de Hongos", 700f, 1100f,
            "Hongos luminosos iluminan el camino.", 250),
        LocationDef("hidden_pond", "Estanque Oculto", 200f, 900f,
            "Aguas cristalinas reflejan el cielo.", 300),
        LocationDef("fairy_circle", "Círculo de Hadas", 600f, 850f,
            "Dicen que aquí bailan las hadas.", 350),
        LocationDef("mossy_cave", "Cueva Musgosa", 400f, 700f,
            "La humedad crea un ecosistema único.", 400),
        LocationDef("waterfall", "Cascada Serena", 150f, 550f,
            "El sonido del agua calma la mente.", 450),
        LocationDef("ancient_ruins", "Ruinas Antiguas", 800f, 600f,
            "Vestigios de una civilización olvidada.", 500),
        LocationDef("flower_meadow", "Pradera Florida", 500f, 450f,
            "Miles de flores pintan el paisaje.", 550),
        LocationDef("owl_tree", "Árbol del Búho", 300f, 350f,
            "Hogar de un sabio búho.", 600),
        LocationDef("crystal_cave", "Cueva de Cristales", 700f, 300f,
            "Cristales brillan en la oscuridad.", 650),
        LocationDef("summit_view", "Mirador de la Cumbre", 500f, 200f,
            "Vista panorámica del bosque.", 700),
        LocationDef("sacred_grove", "Arboleda Sagrada", 200f, 150f,
            "Un lugar de paz y reflexión.", 750),
        LocationDef("dragon_cave", "Cueva del Dragón", 800f, 100f,
            "Leyendas hablan de un dragón dormido.", 800),
        LocationDef("heart_of_forest", "Corazón del Bosque", 500f, 50f,
            "El centro espiritual del bioma.", 1000)
    )
}

data class LocationDef(
    val id: String,
    val name: String,
    val x: Float,
    val y: Float,
    val lore: String,
    val baseCost: Int
)
```

### 2. ExpeditionMapScreen

```kotlin
@Composable
fun ExpeditionMapScreen(
    viewModel: ExpeditionMapViewModel = hiltViewModel(),
    onLocationClick: (String) -> Unit,
    onBack: () -> Unit
) {
    val uiState by viewModel.uiState.collectAsState()

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text(ForestBiomeData.BIOME_NAME) },
                navigationIcon = {
                    IconButton(onClick = onBack) {
                        Icon(Icons.Default.ArrowBack, "Volver")
                    }
                },
                actions = {
                    // Energy display
                    EnergyChip(energy = uiState.currentEnergy)
                }
            )
        }
    ) { padding ->
        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
        ) {
            BiomeMapCanvas(
                discoveredLocations = uiState.discoveredLocationIds,
                currentEnergy = uiState.currentEnergy,
                onLocationClick = { locationId ->
                    viewModel.selectLocation(locationId)
                },
                modifier = Modifier.fillMaxSize()
            )

            // Selected location sheet
            uiState.selectedLocation?.let { location ->
                LocationDetailSheet(
                    location = location,
                    isDiscovered = location.id in uiState.discoveredLocationIds,
                    canAfford = uiState.currentEnergy >= location.cost,
                    onDiscover = { viewModel.discoverLocation(location.id) },
                    onDismiss = { viewModel.clearSelection() }
                )
            }
        }
    }
}
```

### 3. BiomeMapCanvas

```kotlin
@Composable
fun BiomeMapCanvas(
    discoveredLocations: Set<String>,
    currentEnergy: Int,
    onLocationClick: (String) -> Unit,
    modifier: Modifier = Modifier
) {
    var offset by remember { mutableStateOf(Offset.Zero) }
    var scale by remember { mutableStateOf(1f) }

    val transformState = rememberTransformableState { zoomChange, panChange, _ ->
        scale = (scale * zoomChange).coerceIn(0.5f, 2f)
        offset += panChange
    }

    Canvas(
        modifier = modifier
            .transformable(state = transformState)
            .pointerInput(Unit) {
                detectTapGestures { tapOffset ->
                    // Convert tap to map coordinates
                    val mapX = (tapOffset.x - offset.x) / scale
                    val mapY = (tapOffset.y - offset.y) / scale

                    // Find clicked location
                    ForestBiomeData.LOCATIONS.find { loc ->
                        val dx = loc.x - mapX
                        val dy = loc.y - mapY
                        sqrt(dx * dx + dy * dy) < 50f // Hit radius
                    }?.let { location ->
                        onLocationClick(location.id)
                    }
                }
            }
    ) {
        // Apply transformations
        translate(offset.x, offset.y) {
            scale(scale, scale, Offset.Zero) {
                // Draw map background
                drawMapBackground()

                // Draw paths between locations
                drawPaths(discoveredLocations)

                // Draw fog of war
                drawFogOfWar(discoveredLocations)

                // Draw location markers
                ForestBiomeData.LOCATIONS.forEach { location ->
                    val isDiscovered = location.id in discoveredLocations
                    val isAdjacent = isAdjacentToDiscovered(location.id, discoveredLocations)

                    drawLocationMarker(
                        location = location,
                        isDiscovered = isDiscovered,
                        isVisible = isDiscovered || isAdjacent
                    )
                }
            }
        }
    }
}

private fun DrawScope.drawMapBackground() {
    // Draw base map (could be replaced with image)
    drawRect(
        color = Color(0xFF2D5016), // Forest green
        size = Size(ForestBiomeData.MAP_WIDTH, ForestBiomeData.MAP_HEIGHT)
    )

    // Draw some decorative elements (trees, paths, etc.)
    // This could be enhanced with actual bitmap assets
}

private fun DrawScope.drawFogOfWar(discoveredLocations: Set<String>) {
    // Draw semi-transparent overlay on undiscovered areas
    val fogColor = Color.Black.copy(alpha = 0.7f)

    ForestBiomeData.LOCATIONS.forEach { location ->
        if (location.id !in discoveredLocations) {
            drawCircle(
                color = fogColor,
                radius = 100f,
                center = Offset(location.x, location.y),
                blendMode = BlendMode.SrcOver
            )
        }
    }
}

private fun DrawScope.drawLocationMarker(
    location: LocationDef,
    isDiscovered: Boolean,
    isVisible: Boolean
) {
    if (!isVisible) return

    val center = Offset(location.x, location.y)
    val markerColor = when {
        isDiscovered -> Color(0xFF4CAF50) // Green
        else -> Color(0xFFFFB74D) // Orange (undiscovered but visible)
    }

    // Outer glow
    drawCircle(
        color = markerColor.copy(alpha = 0.3f),
        radius = 40f,
        center = center
    )

    // Main marker
    drawCircle(
        color = markerColor,
        radius = 25f,
        center = center
    )

    // Icon indicator
    drawCircle(
        color = Color.White,
        radius = 15f,
        center = center
    )
}
```

### 4. LocationDetailSheet

```kotlin
@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun LocationDetailSheet(
    location: LocationDef,
    isDiscovered: Boolean,
    canAfford: Boolean,
    onDiscover: () -> Unit,
    onDismiss: () -> Unit
) {
    ModalBottomSheet(onDismissRequest = onDismiss) {
        Column(
            modifier = Modifier
                .fillMaxWidth()
                .padding(24.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            // Location icon
            Box(
                modifier = Modifier
                    .size(80.dp)
                    .clip(CircleShape)
                    .background(MaterialTheme.colorScheme.primaryContainer),
                contentAlignment = Alignment.Center
            ) {
                Icon(
                    imageVector = if (isDiscovered) Icons.Default.Place else Icons.Default.Explore,
                    contentDescription = null,
                    modifier = Modifier.size(40.dp),
                    tint = MaterialTheme.colorScheme.primary
                )
            }

            Spacer(modifier = Modifier.height(16.dp))

            Text(
                text = location.name,
                style = MaterialTheme.typography.headlineSmall,
                fontWeight = FontWeight.Bold
            )

            Spacer(modifier = Modifier.height(8.dp))

            if (isDiscovered) {
                Text(
                    text = location.lore,
                    style = MaterialTheme.typography.bodyMedium,
                    textAlign = TextAlign.Center,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
            } else {
                Text(
                    text = "Locación sin descubrir",
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.outline
                )

                Spacer(modifier = Modifier.height(16.dp))

                // Cost display
                Row(
                    verticalAlignment = Alignment.CenterVertically,
                    horizontalArrangement = Arrangement.Center
                ) {
                    Icon(
                        imageVector = Icons.Default.Bolt,
                        contentDescription = null,
                        tint = if (canAfford) MaterialTheme.colorScheme.primary
                               else MaterialTheme.colorScheme.error
                    )
                    Spacer(modifier = Modifier.width(4.dp))
                    Text(
                        text = "${location.baseCost}",
                        style = MaterialTheme.typography.titleMedium,
                        color = if (canAfford) MaterialTheme.colorScheme.primary
                                else MaterialTheme.colorScheme.error
                    )
                }

                Spacer(modifier = Modifier.height(16.dp))

                Button(
                    onClick = onDiscover,
                    enabled = canAfford,
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Icon(Icons.Default.Explore, null)
                    Spacer(modifier = Modifier.width(8.dp))
                    Text("Descubrir")
                }
            }

            Spacer(modifier = Modifier.height(24.dp))
        }
    }
}
```

## Dependencies

- [ ] Task 003 (Domain models y UseCases)

## Effort Estimate

- Size: L
- Hours: 8
- Parallel: false

## Definition of Done

- [ ] Mapa renderiza sin errores
- [ ] Pan gesture suave (<16ms frame time)
- [ ] 15 locaciones visibles/interactuables
- [ ] Fog of war funciona correctamente
- [ ] Descubrimiento resta energía y revela locación
- [ ] Animación de descubrimiento
- [ ] Responsive en diferentes tamaños de pantalla
