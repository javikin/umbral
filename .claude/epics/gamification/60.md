---
name: Integración BlockingManager + HomeScreen
status: open
created: 2026-01-07T05:02:20Z
updated: 2026-01-07T05:13:26Z
github: https://github.com/javikin/umbral/issues/60
depends_on: [55]
parallel: false
conflicts_with: []
---

# Task: Integración BlockingManager + HomeScreen

## Description

Integrar el sistema de gamificación con el flujo existente de bloqueo. Al completar una sesión, el usuario debe ganar Energía y XP. Además, mostrar el compañero activo y el progreso en la HomeScreen.

## Acceptance Criteria

- [ ] BlockingManager notifica al completar sesión
- [ ] GainEnergyUseCase se ejecuta automáticamente
- [ ] Logros se verifican después de cada sesión
- [ ] HomeScreen muestra compañero activo
- [ ] HomeScreen muestra Energía y nivel actual
- [ ] Animación de celebración al ganar recompensas
- [ ] Navegación a Expedición desde Home

## Technical Details

### 1. BlockingManager Integration

```kotlin
// BlockingManager.kt - Modificar clase existente
@HiltViewModel
class BlockingManager @Inject constructor(
    // ... existing dependencies
    private val gainEnergyUseCase: GainEnergyUseCase,
    private val checkAchievementsUseCase: CheckAchievementsUseCase,
    private val expeditionRepository: ExpeditionRepository
) {
    // ... existing code

    private suspend fun completeSession(profileId: String, durationMinutes: Int) {
        // Existing completion logic...

        // NEW: Award expedition rewards
        awardExpeditionRewards(durationMinutes)
    }

    private suspend fun awardExpeditionRewards(durationMinutes: Int) {
        try {
            // 1. Gain energy and XP
            val energyResult = gainEnergyUseCase(durationMinutes)

            // 2. Check achievements
            val progress = expeditionRepository.getProgressSnapshot()
            val unlockedAchievements = checkAchievementsUseCase.checkBlockingAchievements(
                sessionMinutes = durationMinutes,
                totalMinutes = progress.totalBlockingMinutes + durationMinutes,
                currentStreak = progress.currentStreak,
                totalSessions = progress.totalSessions + 1
            )

            // 3. Emit reward event for UI
            _rewardEvent.emit(
                SessionReward(
                    energyGained = energyResult.totalEnergy,
                    xpGained = energyResult.xpGained,
                    multiplier = energyResult.multiplier,
                    unlockedAchievements = unlockedAchievements
                )
            )

            Timber.d("Expedition rewards: +${energyResult.totalEnergy} energy, +${energyResult.xpGained} XP")
        } catch (e: Exception) {
            Timber.e(e, "Failed to award expedition rewards")
            // Don't fail the session completion for gamification errors
        }
    }

    // New event for UI to observe
    private val _rewardEvent = MutableSharedFlow<SessionReward>()
    val rewardEvent: SharedFlow<SessionReward> = _rewardEvent.asSharedFlow()
}

data class SessionReward(
    val energyGained: Int,
    val xpGained: Int,
    val multiplier: Float,
    val unlockedAchievements: List<UnlockedAchievement>
)
```

### 2. HomeViewModel Updates

```kotlin
// HomeViewModel.kt - Add expedition state
@HiltViewModel
class HomeViewModel @Inject constructor(
    // ... existing dependencies
    private val expeditionRepository: ExpeditionRepository,
    private val blockingManager: BlockingManager
) : ViewModel() {

    // ... existing code

    // New: Expedition state
    private val _expeditionState = MutableStateFlow(ExpeditionHomeState())
    val expeditionState: StateFlow<ExpeditionHomeState> = _expeditionState.asStateFlow()

    // New: Reward dialog state
    private val _showRewardDialog = MutableStateFlow<SessionReward?>(null)
    val showRewardDialog: StateFlow<SessionReward?> = _showRewardDialog.asStateFlow()

    init {
        loadState()
        observeExpedition()
        observeRewards()
    }

    private fun observeExpedition() {
        viewModelScope.launch {
            combine(
                expeditionRepository.getProgress(),
                expeditionRepository.getActiveCompanion()
            ) { progress, companion ->
                ExpeditionHomeState(
                    level = progress.level,
                    currentXp = progress.currentXp,
                    xpForNextLevel = ExpeditionFormulas.xpForLevel(progress.level),
                    totalEnergy = progress.totalEnergy,
                    currentStreak = progress.currentStreak,
                    activeCompanion = companion?.let {
                        ActiveCompanionState(
                            type = CompanionType.valueOf(it.type),
                            evolutionState = it.evolutionState
                        )
                    }
                )
            }.collect { state ->
                _expeditionState.value = state
            }
        }
    }

    private fun observeRewards() {
        viewModelScope.launch {
            blockingManager.rewardEvent.collect { reward ->
                _showRewardDialog.value = reward
            }
        }
    }

    fun dismissRewardDialog() {
        _showRewardDialog.value = null
    }
}

data class ExpeditionHomeState(
    val level: Int = 1,
    val currentXp: Int = 0,
    val xpForNextLevel: Int = 100,
    val totalEnergy: Int = 0,
    val currentStreak: Int = 0,
    val activeCompanion: ActiveCompanionState? = null
)

data class ActiveCompanionState(
    val type: CompanionType,
    val evolutionState: Int
)
```

### 3. HomeScreen Updates

```kotlin
// HomeScreen.kt - Add expedition card
@Composable
fun HomeScreenContent(
    uiState: HomeUiState,
    expeditionState: ExpeditionHomeState,
    showRewardDialog: SessionReward?,
    onToggleBlocking: () -> Unit,
    onExpeditionClick: () -> Unit,
    onCompanionClick: () -> Unit,
    onDismissReward: () -> Unit,
    // ... other params
) {
    // ... existing animation states
    var showExpeditionCard by remember { mutableStateOf(false) }

    LaunchedEffect(Unit) {
        // ... existing animations
        delay(300)
        showExpeditionCard = true
    }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .verticalScroll(rememberScrollState())
            .padding(horizontal = UmbralSpacing.lg)
    ) {
        // ... existing Status Card

        // NEW: Expedition Progress Card (replaces or complements StatsPreviewCard)
        AnimatedVisibility(
            visible = showExpeditionCard,
            enter = fadeIn() + slideInVertically(initialOffsetY = { 50 })
        ) {
            ExpeditionProgressCard(
                state = expeditionState,
                onExpeditionClick = onExpeditionClick,
                onCompanionClick = onCompanionClick,
                modifier = Modifier.padding(top = UmbralSpacing.lg)
            )
        }

        // ... rest of existing cards
    }

    // Reward Dialog
    showRewardDialog?.let { reward ->
        SessionRewardDialog(
            reward = reward,
            onDismiss = onDismissReward
        )
    }
}

@Composable
fun ExpeditionProgressCard(
    state: ExpeditionHomeState,
    onExpeditionClick: () -> Unit,
    onCompanionClick: () -> Unit,
    modifier: Modifier = Modifier
) {
    UmbralCard(
        modifier = modifier.fillMaxWidth(),
        onClick = onExpeditionClick
    ) {
        Column(modifier = Modifier.padding(UmbralSpacing.lg)) {
            // Header row
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Column {
                    Text(
                        text = "Expedición",
                        style = MaterialTheme.typography.titleMedium,
                        fontWeight = FontWeight.Bold
                    )
                    Text(
                        text = "Nivel ${state.level}",
                        style = MaterialTheme.typography.bodySmall,
                        color = MaterialTheme.colorScheme.primary
                    )
                }

                // Active companion
                state.activeCompanion?.let { companion ->
                    Surface(
                        onClick = onCompanionClick,
                        shape = CircleShape,
                        color = MaterialTheme.colorScheme.primaryContainer
                    ) {
                        Box(
                            modifier = Modifier.size(48.dp),
                            contentAlignment = Alignment.Center
                        ) {
                            // Companion mini animation or icon
                            Text(
                                text = companion.type.displayName.first().toString(),
                                style = MaterialTheme.typography.titleMedium,
                                fontWeight = FontWeight.Bold
                            )
                        }
                    }
                }
            }

            Spacer(modifier = Modifier.height(UmbralSpacing.md))

            // XP Progress bar
            Column {
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceBetween
                ) {
                    Text(
                        text = "XP",
                        style = MaterialTheme.typography.labelSmall
                    )
                    Text(
                        text = "${state.currentXp}/${state.xpForNextLevel}",
                        style = MaterialTheme.typography.labelSmall
                    )
                }
                LinearProgressIndicator(
                    progress = { state.currentXp.toFloat() / state.xpForNextLevel },
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(top = 4.dp)
                )
            }

            Spacer(modifier = Modifier.height(UmbralSpacing.md))

            // Stats row
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceEvenly
            ) {
                StatItem(
                    icon = Icons.Default.Bolt,
                    value = "${state.totalEnergy}",
                    label = "Energía"
                )
                StatItem(
                    icon = Icons.Default.LocalFireDepartment,
                    value = "${state.currentStreak}",
                    label = "Racha"
                )
            }

            Spacer(modifier = Modifier.height(UmbralSpacing.sm))

            // Explore button
            OutlinedButton(
                onClick = onExpeditionClick,
                modifier = Modifier.fillMaxWidth()
            ) {
                Icon(Icons.Default.Explore, null)
                Spacer(modifier = Modifier.width(8.dp))
                Text("Explorar mapa")
            }
        }
    }
}

@Composable
private fun StatItem(
    icon: ImageVector,
    value: String,
    label: String
) {
    Column(horizontalAlignment = Alignment.CenterHorizontally) {
        Row(verticalAlignment = Alignment.CenterVertically) {
            Icon(
                imageVector = icon,
                contentDescription = null,
                modifier = Modifier.size(16.dp),
                tint = MaterialTheme.colorScheme.primary
            )
            Spacer(modifier = Modifier.width(4.dp))
            Text(
                text = value,
                style = MaterialTheme.typography.titleMedium,
                fontWeight = FontWeight.Bold
            )
        }
        Text(
            text = label,
            style = MaterialTheme.typography.labelSmall,
            color = MaterialTheme.colorScheme.onSurfaceVariant
        )
    }
}
```

### 4. SessionRewardDialog

```kotlin
@Composable
fun SessionRewardDialog(
    reward: SessionReward,
    onDismiss: () -> Unit
) {
    val composition by rememberLottieComposition(
        spec = LottieCompositionSpec.Asset(LottieAnimations.COMPANION_HAPPY)
    )

    Dialog(onDismissRequest = onDismiss) {
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(16.dp),
            shape = RoundedCornerShape(24.dp)
        ) {
            Column(
                modifier = Modifier.padding(24.dp),
                horizontalAlignment = Alignment.CenterHorizontally
            ) {
                // Celebration animation
                LottieAnimation(
                    composition = composition,
                    iterations = 2,
                    modifier = Modifier.size(120.dp)
                )

                Text(
                    text = "¡Sesión completada!",
                    style = MaterialTheme.typography.headlineSmall,
                    fontWeight = FontWeight.Bold
                )

                Spacer(modifier = Modifier.height(16.dp))

                // Rewards
                Row(
                    modifier = Modifier.fillMaxWidth(),
                    horizontalArrangement = Arrangement.SpaceEvenly
                ) {
                    RewardItem(
                        icon = Icons.Default.Bolt,
                        value = "+${reward.energyGained}",
                        label = "Energía",
                        color = MaterialTheme.colorScheme.primary
                    )
                    RewardItem(
                        icon = Icons.Default.Star,
                        value = "+${reward.xpGained}",
                        label = "XP",
                        color = MaterialTheme.colorScheme.tertiary
                    )
                }

                // Multiplier badge
                if (reward.multiplier > 1f) {
                    Spacer(modifier = Modifier.height(8.dp))
                    Surface(
                        color = MaterialTheme.colorScheme.secondaryContainer,
                        shape = RoundedCornerShape(8.dp)
                    ) {
                        Text(
                            text = "x${reward.multiplier} racha bonus",
                            modifier = Modifier.padding(horizontal = 12.dp, vertical = 4.dp),
                            style = MaterialTheme.typography.labelMedium
                        )
                    }
                }

                // Unlocked achievements
                if (reward.unlockedAchievements.isNotEmpty()) {
                    Spacer(modifier = Modifier.height(16.dp))
                    Divider()
                    Spacer(modifier = Modifier.height(16.dp))

                    Text(
                        text = "¡Logros desbloqueados!",
                        style = MaterialTheme.typography.titleSmall
                    )

                    reward.unlockedAchievements.forEach { achievement ->
                        Spacer(modifier = Modifier.height(8.dp))
                        Row(
                            verticalAlignment = Alignment.CenterVertically
                        ) {
                            Icon(
                                imageVector = Icons.Default.EmojiEvents,
                                contentDescription = null,
                                tint = MaterialTheme.colorScheme.primary
                            )
                            Spacer(modifier = Modifier.width(8.dp))
                            Text(text = achievement.title)
                            Spacer(modifier = Modifier.weight(1f))
                            Text(
                                text = "+${achievement.starsEarned}⭐",
                                color = MaterialTheme.colorScheme.primary
                            )
                        }
                    }
                }

                Spacer(modifier = Modifier.height(24.dp))

                Button(
                    onClick = onDismiss,
                    modifier = Modifier.fillMaxWidth()
                ) {
                    Text("¡Genial!")
                }
            }
        }
    }
}
```

### 5. Navigation Updates

```kotlin
// MainNavigation.kt - Add expedition routes
sealed class Screen(val route: String) {
    // ... existing screens
    object ExpeditionMap : Screen("expedition/map")
    object CompanionList : Screen("expedition/companions")
    object CompanionDetail : Screen("expedition/companion/{companionId}") {
        fun createRoute(companionId: String) = "expedition/companion/$companionId"
    }
    object Achievements : Screen("expedition/achievements")
}

// In NavHost
composable(Screen.ExpeditionMap.route) {
    ExpeditionMapScreen(
        onBack = { navController.popBackStack() },
        onLocationClick = { /* handle */ }
    )
}

composable(Screen.CompanionList.route) {
    CompanionListScreen(
        onBack = { navController.popBackStack() },
        onCompanionClick = { id ->
            navController.navigate(Screen.CompanionDetail.createRoute(id))
        }
    )
}

composable(
    route = Screen.CompanionDetail.route,
    arguments = listOf(navArgument("companionId") { type = NavType.StringType })
) { backStackEntry ->
    val companionId = backStackEntry.arguments?.getString("companionId") ?: return@composable
    CompanionDetailScreen(
        companionId = companionId,
        onBack = { navController.popBackStack() }
    )
}

composable(Screen.Achievements.route) {
    AchievementsScreen(
        onBack = { navController.popBackStack() }
    )
}
```

## Dependencies

- [ ] Task 003 (Domain models y UseCases)

## Effort Estimate

- Size: M
- Hours: 4
- Parallel: false

## Definition of Done

- [ ] BlockingManager emite recompensas al completar
- [ ] HomeScreen muestra ExpeditionProgressCard
- [ ] Compañero activo visible en Home
- [ ] Diálogo de recompensas aparece post-sesión
- [ ] Navegación a todas las pantallas de Expedition
- [ ] Sin regresiones en funcionalidad de bloqueo existente
