---
name: Setup módulo Expedition + DB migrations
status: open
created: 2026-01-07T05:02:20Z
updated: 2026-01-07T05:13:26Z
github: https://github.com/javikin/umbral/issues/53
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Setup módulo Expedition + DB migrations

## Description

Crear la estructura base del módulo de Expedición y las migraciones de base de datos necesarias. Este task establece los cimientos para todo el sistema de gamificación.

## Acceptance Criteria

- [ ] Package `com.umbral.expedition` creado con estructura de carpetas
- [ ] Dependencia Lottie Compose agregada a build.gradle
- [ ] Migration de Room creada con las 5 tablas nuevas
- [ ] UmbralDatabase actualizado para incluir nuevos DAOs
- [ ] ExpeditionModule de Hilt creado y registrado
- [ ] Build compila sin errores
- [ ] Tests de migration pasan

## Technical Details

### 1. Estructura de Carpetas

```
app/src/main/java/com/umbral/expedition/
├── data/
│   ├── dao/
│   ├── entity/
│   └── repository/
├── domain/
│   ├── model/
│   └── usecase/
├── presentation/
│   ├── map/
│   ├── companion/
│   ├── sanctuary/
│   ├── achievements/
│   └── components/
└── di/
    └── ExpeditionModule.kt
```

### 2. Dependencias (build.gradle.kts)

```kotlin
// Lottie for animations
implementation("com.airbnb.android:lottie-compose:6.3.0")
```

### 3. Migration SQL

```sql
-- Migration_X_Y.kt

CREATE TABLE companions (
    id TEXT PRIMARY KEY,
    type TEXT NOT NULL,
    name TEXT,
    evolution_state INTEGER DEFAULT 1,
    energy_invested INTEGER DEFAULT 0,
    captured_at INTEGER NOT NULL,
    is_active INTEGER DEFAULT 0,
    UNIQUE(type)
);

CREATE TABLE discovered_locations (
    id TEXT PRIMARY KEY,
    biome_id TEXT NOT NULL,
    discovered_at INTEGER NOT NULL,
    energy_spent INTEGER NOT NULL,
    lore_read INTEGER DEFAULT 0
);

CREATE TABLE player_progress (
    id INTEGER PRIMARY KEY DEFAULT 1,
    level INTEGER DEFAULT 1,
    current_xp INTEGER DEFAULT 0,
    total_energy INTEGER DEFAULT 0,
    stars INTEGER DEFAULT 0,
    current_streak INTEGER DEFAULT 0,
    longest_streak INTEGER DEFAULT 0,
    total_blocking_minutes INTEGER DEFAULT 0
);

CREATE TABLE achievements (
    id TEXT PRIMARY KEY,
    category TEXT NOT NULL,
    progress INTEGER DEFAULT 0,
    target INTEGER NOT NULL,
    unlocked_at INTEGER,
    stars_reward INTEGER NOT NULL
);

CREATE TABLE sanctuary_decorations (
    id TEXT PRIMARY KEY,
    type TEXT NOT NULL,
    position_x REAL,
    position_y REAL,
    purchased_at INTEGER NOT NULL
);

CREATE INDEX idx_achievements_category ON achievements(category);
CREATE INDEX idx_locations_biome ON discovered_locations(biome_id);
```

### 4. ExpeditionModule.kt

```kotlin
@Module
@InstallIn(SingletonComponent::class)
object ExpeditionModule {

    @Provides
    @Singleton
    fun provideCompanionDao(database: UmbralDatabase): CompanionDao {
        return database.companionDao()
    }

    @Provides
    @Singleton
    fun provideLocationDao(database: UmbralDatabase): LocationDao {
        return database.locationDao()
    }

    // ... otros DAOs

    @Provides
    @Singleton
    fun provideExpeditionRepository(
        companionDao: CompanionDao,
        locationDao: LocationDao,
        progressDao: ProgressDao,
        achievementDao: AchievementDao
    ): ExpeditionRepository {
        return ExpeditionRepositoryImpl(
            companionDao, locationDao, progressDao, achievementDao
        )
    }
}
```

### 5. Actualizar UmbralDatabase

```kotlin
@Database(
    entities = [
        // Existing entities...
        CompanionEntity::class,
        LocationEntity::class,
        ProgressEntity::class,
        AchievementEntity::class,
        DecorationEntity::class
    ],
    version = X, // Incrementar
    autoMigrations = [
        AutoMigration(from = X-1, to = X)
    ]
)
abstract class UmbralDatabase : RoomDatabase() {
    // Existing DAOs...
    abstract fun companionDao(): CompanionDao
    abstract fun locationDao(): LocationDao
    abstract fun progressDao(): ProgressDao
    abstract fun achievementDao(): AchievementDao
    abstract fun decorationDao(): DecorationDao
}
```

## Dependencies

- [ ] Ninguna - este es el primer task

## Effort Estimate

- Size: M
- Hours: 4
- Parallel: true

## Definition of Done

- [ ] Estructura de carpetas creada
- [ ] build.gradle actualizado con Lottie
- [ ] Migration creada y testeada
- [ ] UmbralDatabase actualizado
- [ ] ExpeditionModule registrado en Hilt
- [ ] App compila y ejecuta sin crash
- [ ] Fresh install funciona correctamente
