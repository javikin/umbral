---
name: Entities, DAOs y Repository base
status: open
created: 2026-01-07T05:02:20Z
updated: 2026-01-07T05:13:26Z
github: https://github.com/javikin/umbral/issues/54
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Entities, DAOs y Repository base

## Description

Implementar todas las entidades de Room, DAOs con queries necesarias, y el repositorio base que expone las operaciones de datos del módulo Expedition.

## Acceptance Criteria

- [ ] 5 Entity classes creadas con anotaciones Room correctas
- [ ] 5 DAO interfaces con queries CRUD + específicas
- [ ] ExpeditionRepository interface definida
- [ ] ExpeditionRepositoryImpl implementado
- [ ] Flows para observar cambios reactivamente
- [ ] Unit tests para DAOs

## Technical Details

### 1. CompanionEntity.kt

```kotlin
@Entity(tableName = "companions")
data class CompanionEntity(
    @PrimaryKey
    val id: String,
    @ColumnInfo(name = "type")
    val type: String,
    @ColumnInfo(name = "name")
    val name: String?,
    @ColumnInfo(name = "evolution_state")
    val evolutionState: Int = 1,
    @ColumnInfo(name = "energy_invested")
    val energyInvested: Int = 0,
    @ColumnInfo(name = "captured_at")
    val capturedAt: Long,
    @ColumnInfo(name = "is_active")
    val isActive: Boolean = false
)
```

### 2. CompanionDao.kt

```kotlin
@Dao
interface CompanionDao {
    @Query("SELECT * FROM companions ORDER BY captured_at DESC")
    fun getAllCompanions(): Flow<List<CompanionEntity>>

    @Query("SELECT * FROM companions WHERE is_active = 1 LIMIT 1")
    fun getActiveCompanion(): Flow<CompanionEntity?>

    @Query("SELECT * FROM companions WHERE type = :type")
    suspend fun getByType(type: String): CompanionEntity?

    @Query("SELECT COUNT(*) FROM companions")
    suspend fun getCompanionCount(): Int

    @Insert(onConflict = OnConflictStrategy.REPLACE)
    suspend fun insert(companion: CompanionEntity)

    @Update
    suspend fun update(companion: CompanionEntity)

    @Query("UPDATE companions SET is_active = 0")
    suspend fun deactivateAll()

    @Query("UPDATE companions SET is_active = 1 WHERE id = :id")
    suspend fun setActive(id: String)

    @Query("UPDATE companions SET evolution_state = :state, energy_invested = :energy WHERE id = :id")
    suspend fun evolve(id: String, state: Int, energy: Int)
}
```

### 3. LocationEntity.kt

```kotlin
@Entity(
    tableName = "discovered_locations",
    indices = [Index(value = ["biome_id"])]
)
data class LocationEntity(
    @PrimaryKey
    val id: String,
    @ColumnInfo(name = "biome_id")
    val biomeId: String,
    @ColumnInfo(name = "discovered_at")
    val discoveredAt: Long,
    @ColumnInfo(name = "energy_spent")
    val energySpent: Int,
    @ColumnInfo(name = "lore_read")
    val loreRead: Boolean = false
)
```

### 4. ProgressEntity.kt

```kotlin
@Entity(tableName = "player_progress")
data class ProgressEntity(
    @PrimaryKey
    val id: Int = 1,
    @ColumnInfo(name = "level")
    val level: Int = 1,
    @ColumnInfo(name = "current_xp")
    val currentXp: Int = 0,
    @ColumnInfo(name = "total_energy")
    val totalEnergy: Int = 0,
    @ColumnInfo(name = "stars")
    val stars: Int = 0,
    @ColumnInfo(name = "current_streak")
    val currentStreak: Int = 0,
    @ColumnInfo(name = "longest_streak")
    val longestStreak: Int = 0,
    @ColumnInfo(name = "total_blocking_minutes")
    val totalBlockingMinutes: Int = 0
)
```

### 5. AchievementEntity.kt

```kotlin
@Entity(
    tableName = "achievements",
    indices = [Index(value = ["category"])]
)
data class AchievementEntity(
    @PrimaryKey
    val id: String,
    @ColumnInfo(name = "category")
    val category: String,
    @ColumnInfo(name = "progress")
    val progress: Int = 0,
    @ColumnInfo(name = "target")
    val target: Int,
    @ColumnInfo(name = "unlocked_at")
    val unlockedAt: Long? = null,
    @ColumnInfo(name = "stars_reward")
    val starsReward: Int
)
```

### 6. ExpeditionRepository Interface

```kotlin
interface ExpeditionRepository {
    // Progress
    fun getProgress(): Flow<ProgressEntity>
    suspend fun addEnergy(amount: Int)
    suspend fun addXp(amount: Int)
    suspend fun updateStreak(streak: Int)

    // Companions
    fun getAllCompanions(): Flow<List<CompanionEntity>>
    fun getActiveCompanion(): Flow<CompanionEntity?>
    suspend fun captureCompanion(type: String)
    suspend fun evolveCompanion(id: String)
    suspend fun setActiveCompanion(id: String)

    // Locations
    fun getDiscoveredLocations(): Flow<List<LocationEntity>>
    suspend fun discoverLocation(locationId: String, biomeId: String, energyCost: Int)
    suspend fun getDiscoveryCount(): Int

    // Achievements
    fun getAchievements(): Flow<List<AchievementEntity>>
    fun getUnlockedAchievements(): Flow<List<AchievementEntity>>
    suspend fun updateAchievementProgress(id: String, progress: Int)
    suspend fun unlockAchievement(id: String)
}
```

## Dependencies

- [ ] Puede desarrollarse en paralelo con Task 001

## Effort Estimate

- Size: M
- Hours: 6
- Parallel: true

## Definition of Done

- [ ] Todas las entities compilando
- [ ] Todos los DAOs con queries correctas
- [ ] Repository interface completa
- [ ] Repository implementation funcional
- [ ] Unit tests para operaciones críticas
- [ ] Flows emiten datos correctamente
