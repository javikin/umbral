---
name: tests-database-integration
status: closed
priority: medium
github: https://github.com/javikin/umbral/issues/13
created: 2026-01-04T03:42:34Z
updated: 2026-01-04T03:45:00Z
depends_on: [12]
parallel: false
---

# Task 13: Tests de Integraci贸n Database

## Descripci贸n

Tests de integraci贸n para Room Database usando base de datos in-memory.

## Archivos a crear

1. `app/src/androidTest/java/com/umbral/data/db/ProfileDaoTest.kt`
2. `app/src/androidTest/java/com/umbral/data/db/StatsDaoTest.kt`
3. `app/src/androidTest/java/com/umbral/data/db/DatabaseMigrationTest.kt`

## Configuraci贸n

### Test Database

```kotlin
@RunWith(AndroidJUnit4::class)
class ProfileDaoTest {
    private lateinit var database: UmbralDatabase
    private lateinit var profileDao: ProfileDao

    @Before
    fun setup() {
        val context = ApplicationProvider.getApplicationContext<Context>()
        database = Room.inMemoryDatabaseBuilder(
            context,
            UmbralDatabase::class.java
        ).allowMainThreadQueries().build()

        profileDao = database.profileDao()
    }

    @After
    fun teardown() {
        database.close()
    }
}
```

## Casos de Test

### ProfileDao Tests

```kotlin
@Test
fun insertAndRetrieveProfile() = runTest {
    val profile = ProfileEntity(
        id = "test-1",
        name = "Work",
        iconName = "briefcase",
        colorHex = "#FF5722",
        isStrictMode = false,
        createdAt = System.currentTimeMillis()
    )

    profileDao.insert(profile)

    val retrieved = profileDao.getById("test-1")
    assertThat(retrieved).isEqualTo(profile)
}

@Test
fun observeProfilesEmitsUpdates() = runTest {
    val profiles = profileDao.observeAll().first()
    assertThat(profiles).isEmpty()

    profileDao.insert(testProfile)

    val updated = profileDao.observeAll().first()
    assertThat(updated).hasSize(1)
}

@Test
fun deleteProfileRemovesFromDatabase() = runTest {
    profileDao.insert(testProfile)
    profileDao.delete(testProfile.id)

    val result = profileDao.getById(testProfile.id)
    assertThat(result).isNull()
}

@Test
fun updateProfileModifiesExisting() = runTest {
    profileDao.insert(testProfile)

    val updated = testProfile.copy(name = "Updated")
    profileDao.update(updated)

    val result = profileDao.getById(testProfile.id)
    assertThat(result?.name).isEqualTo("Updated")
}
```

### StatsDao Tests

```kotlin
@Test
fun recordSessionAndQuery() = runTest {
    val session = BlockingSessionEntity(
        id = "session-1",
        profileId = "profile-1",
        startTime = yesterday,
        endTime = yesterday + 3600000,
        blockedAppsCount = 5
    )

    statsDao.insertSession(session)

    val sessions = statsDao.getSessionsForDateRange(
        startOfYesterday, endOfYesterday
    )
    assertThat(sessions).hasSize(1)
}
```

## Dependencias

```kotlin
// build.gradle.kts
androidTestImplementation("androidx.test:runner:1.5.2")
androidTestImplementation("androidx.test.ext:junit:1.1.5")
androidTestImplementation("androidx.room:room-testing:2.6.1")
androidTestImplementation("com.google.truth:truth:1.1.5")
```

## Criterio de Done

- [ ] ProfileDao tests completos
- [ ] StatsDao tests completos
- [ ] Migration tests (si hay migraciones)
- [ ] Tests pasan en CI con emulador
